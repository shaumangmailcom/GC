<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Contractor Draw Portal</title>

  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .glass-card { box-shadow: 0 20px 70px rgba(15, 23, 42, 0.12); }
  </style>
</head>

<body class="bg-gray-50 min-h-screen">

  <!-- PIN MODAL -->
  <div id="pinModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-6 md:p-8 w-full max-w-md shadow-2xl">
      <p class="text-xs uppercase tracking-[0.2em] text-slate-500">Secure Access</p>
      <h2 class="text-2xl font-semibold text-slate-900 mt-2">Enter Contractor PIN</h2>
      <p class="text-sm text-slate-600 mt-2">
        Use your 4-digit PIN so we can load only your assigned projects.
      </p>

      <form id="pinForm" class="mt-5 space-y-4">
        <div class="space-y-2">
          <label for="pinInput" class="block text-sm font-medium text-slate-700">4-digit PIN</label>
          <input
            id="pinInput"
            type="text"
            inputmode="numeric"
            pattern="[0-9]{4}"
            maxlength="4"
            required
            placeholder="1234"
            class="w-full rounded-xl border border-slate-200 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-slate-900/50 tracking-[0.3em] text-center text-lg"
          />
          <p id="pinError" class="text-xs text-rose-600 hidden">That PIN was not recognized. Please try again.</p>
          <p id="pinLoading" class="text-xs text-slate-500 hidden">Loading your projects...</p>
        </div>

        <div class="flex justify-end gap-3">
          <button
            type="submit"
            class="inline-flex items-center gap-2 bg-slate-900 text-white px-4 py-2.5 rounded-xl font-semibold shadow-lg shadow-slate-900/15 hover:bg-slate-800 transition"
            id="pinSubmit"
          >
            Continue
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- OK MODAL (after submit) -->
  <div id="okModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-6 md:p-8 w-full max-w-md shadow-2xl">
      <p class="text-xs uppercase tracking-[0.2em] text-slate-500">Done</p>
      <h2 id="okTitle" class="text-2xl font-semibold text-slate-900 mt-2">Submitted</h2>
      <p id="okBody" class="text-sm text-slate-600 mt-2">Your draw request was submitted.</p>
      <div class="flex justify-end mt-6">
        <button id="okBtn" class="bg-slate-900 text-white px-5 py-2.5 rounded-xl font-semibold hover:bg-slate-800 transition">
          OK
        </button>
      </div>
    </div>
  </div>

  <div class="max-w-6xl mx-auto px-4 py-10">
    <header class="mb-8 text-center">
      <p class="text-sm uppercase tracking-[0.2em] text-slate-500">Contractor Draw Portal</p>

      <!-- Contractor name headline only -->
      <h1 id="headerContractorName" class="text-3xl md:text-4xl font-semibold text-slate-900 mt-2">—</h1>
      <p class="text-xs uppercase tracking-[0.2em] text-slate-500 mt-2">Draw Request</p>

      <p class="text-slate-600 mt-3 max-w-3xl mx-auto">
        Select your project, add a trade line item, upload an invoice, and see your estimated payment timeline.
      </p>
    </header>

    <main class="bg-white glass-card rounded-2xl p-6 md:p-8">
      <form id="drawForm" class="space-y-8">

        <section class="grid md:grid-cols-2 gap-6">
          <div class="space-y-2">
            <label class="block text-sm font-medium text-slate-700">Project</label>
            <select
              id="projectSelect"
              class="w-full rounded-xl border border-slate-200 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-slate-900/50"
              required
              disabled
            >
              <option value="" selected>Verify PIN to load projects</option>
            </select>
            <p id="projectHint" class="text-xs text-slate-500">Projects are filtered to your account.</p>
          </div>

          <div class="space-y-2">
            <label class="block text-sm font-medium text-slate-700">Date of Work</label>
            <input
              id="workDate"
              type="text"
              placeholder="MM/DD/YYYY"
              class="w-full rounded-xl border border-slate-200 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-slate-900/50"
              required
              disabled
            />
            <p id="bufferMessage" class="text-xs text-amber-600"></p>
          </div>
        </section>

        <section class="grid md:grid-cols-2 gap-6">
          <div class="space-y-2">
            <label class="block text-sm font-medium text-slate-700">Estimated Payment Date</label>
            <div
              id="estimatedPayment"
              class="rounded-xl border border-dashed border-slate-200 px-4 py-3 text-slate-800 bg-slate-50"
            >
              Select a work date to calculate.
            </div>
          </div>

          <div class="space-y-2">
            <label class="block text-sm font-medium text-slate-700">Total Draw Request</label>
            <div id="totalAmount" class="rounded-xl border border-slate-200 px-4 py-3 text-slate-900 font-semibold bg-slate-50">
              $0.00
            </div>
          </div>
        </section>

        <section class="border border-slate-100 rounded-2xl p-4 md:p-6 bg-slate-50/60">
          <div class="flex items-center justify-between mb-4">
            <div>
              <p class="text-xs uppercase tracking-[0.2em] text-slate-500">Draw Details</p>
              <h2 class="text-xl font-semibold text-slate-900">Trade Line Item</h2>
            </div>
            <p class="text-sm text-slate-600">Each draw is limited to a single trade.</p>
          </div>

          <div id="lineItems" class="space-y-4"></div>
        </section>

        <section class="grid md:grid-cols-2 gap-6">
          <div class="space-y-2">
            <label class="block text-sm font-medium text-slate-700">Invoice Upload</label>
            <div
              id="dropzone"
              class="border-2 border-dashed border-slate-200 rounded-xl px-4 py-8 text-center bg-slate-50/60 cursor-pointer"
            >
              <p class="text-slate-800 font-medium">Drag & drop your PDF/Image invoice</p>
              <p class="text-xs text-slate-500 mt-2">Single file only. Converted to Base64 for submission.</p>
              <input id="fileInput" type="file" accept="application/pdf,image/*" class="hidden" />
              <div id="fileInfo" class="text-sm text-slate-700 mt-3"></div>
            </div>
          </div>

          <div class="space-y-3 p-4 rounded-xl bg-slate-50/60 border border-slate-100">
            <h3 class="text-sm uppercase tracking-[0.2em] text-slate-500">Submission Summary</h3>
            <ul class="space-y-2 text-sm text-slate-700" id="summaryList">
              <li>Contractor: —</li>
              <li>Project: —</li>
              <li>Trade: —</li>
              <li>Amount: $0.00</li>
              <li>Invoice: Pending</li>
            </ul>

            <button
              id="submitBtn"
              type="submit"
              class="w-full mt-2 inline-flex justify-center items-center gap-2 bg-slate-900 text-white px-5 py-3 rounded-xl font-semibold shadow-lg shadow-slate-900/15 hover:bg-slate-800 transition disabled:opacity-50 disabled:cursor-not-allowed"
              disabled
            >
              Submit Draw Request
            </button>

            <p id="submitMessage" class="text-xs text-rose-600"></p>
          </div>
        </section>

      </form>
    </main>

    <section class="mt-10 bg-white glass-card rounded-2xl p-6 md:p-8">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
        <div>
          <p class="text-xs uppercase tracking-[0.2em] text-slate-500">Status Tracking</p>
          <h2 class="text-xl font-semibold text-slate-900">Track My Payments</h2>
          <p class="text-sm text-slate-600 mt-1">This list shows only your submitted draws.</p>
        </div>
        <input
          id="searchInput"
          type="text"
          placeholder="Search by project, trade, or status"
          class="w-full md:w-80 rounded-xl border border-slate-200 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-slate-900/50"
          disabled
        />
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-left text-sm">
          <thead>
            <tr class="text-slate-500">
              <th class="py-3 pr-4">Project</th>
              <th class="py-3 pr-4">Trade</th>
              <th class="py-3 pr-4">Amount</th>
              <th class="py-3 pr-4">Status</th>
              <th class="py-3 pr-4">Updated</th>
            </tr>
          </thead>
          <tbody id="statusTable" class="divide-y divide-slate-100">
            <tr><td class="py-4 text-slate-500" colspan="5">Verify PIN to load your payment status.</td></tr>
          </tbody>
        </table>
      </div>
    </section>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    // ✅ Replace with your latest Apps Script Web App URL (NEW deployment)
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzHH6DEgjr-jexZGuqDk9kpzIBL4SeDAGzS62KcIS1Lehy8nnX3_fWfWv4yKYhccZs9Kg/exec';

    const state = {
      pin: null,
      contractor: null,
      budgets: [],
      statusRows: [],
      invoiceBase64: null,
      invoiceName: '',
    };

    // Warm-up (helps reduce first-call delay)
    fetch(`${SCRIPT_URL}?action=ping`).catch(() => {});

    function showOkModal(title, body) {
      document.getElementById('okTitle').textContent = title;
      document.getElementById('okBody').textContent = body;
      const modal = document.getElementById('okModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function hideOkModal() {
      const modal = document.getElementById('okModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    document.getElementById('okBtn').addEventListener('click', hideOkModal);

    function formatCurrency(value) {
      const number = Number(value) || 0;
      return number.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
    }

    function addDays(date, days) {
      const copy = new Date(date);
      copy.setDate(copy.getDate() + days);
      return copy;
    }

    function nextThursday(date) {
      const result = new Date(date);
      const day = result.getDay();
      const delta = (11 - day) % 7 || 7;
      result.setDate(result.getDate() + delta);
      return result;
    }

    async function apiGet(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error('Network error');
      return await res.json();
    }

    async function verifyContractor(pin) {
      const url = `${SCRIPT_URL}?action=contractor&pin=${encodeURIComponent(pin)}`;
      const data = await apiGet(url);
      return data?.contractor || null;
    }

    async function loadBudgetsAndStatus() {
      const projectSelect = document.getElementById('projectSelect');
      projectSelect.disabled = true;
      projectSelect.innerHTML = '<option selected>Loading projects...</option>';

      const pin = state.pin;

      const [bud, stat] = await Promise.all([
        apiGet(`${SCRIPT_URL}?action=budgets&pin=${encodeURIComponent(pin)}`),
        apiGet(`${SCRIPT_URL}?action=status&pin=${encodeURIComponent(pin)}`),
      ]);

      state.budgets = (bud?.ok && Array.isArray(bud.budgets)) ? bud.budgets : [];
      state.statusRows = (stat?.ok && Array.isArray(stat.rows)) ? stat.rows : [];

      populateProjects();
      renderLineItems();
      renderStatusTable(state.statusRows);

      // enable form
      projectSelect.disabled = false;
      document.getElementById('workDate').disabled = false;
      document.getElementById('submitBtn').disabled = false;
      document.getElementById('searchInput').disabled = false;

      // If only one project, auto-select it
      const projects = [...new Set(state.budgets.map(b => b.project))];
      if (projects.length === 1) {
        projectSelect.value = projects[0];
        renderLineItems();
        updateSummary();
      } else {
        updateSummary();
      }
    }

    function populateProjects() {
      const select = document.getElementById('projectSelect');
      const projects = [...new Set(state.budgets.map((b) => b.project))];

      select.innerHTML = '<option value="" disabled selected>Select a project</option>';

      if (!projects.length) {
        select.innerHTML = '<option value="" selected>No projects assigned</option>';
        select.disabled = true;
        document.getElementById('submitBtn').disabled = true;
      }

      projects.forEach((project) => {
        const option = document.createElement('option');
        option.value = project;
        option.textContent = project;
        select.appendChild(option);
      });
    }

    function getTradesForProject(project) {
      return state.budgets.filter((b) => b.project === project);
    }

    function renderLineItems() {
      const container = document.getElementById('lineItems');
      container.innerHTML = '';
      container.appendChild(createLineItemRow(0));
      updateTotals();
    }

    function createLineItemRow(index) {
      const project = document.getElementById('projectSelect').value;
      const trades = project ? getTradesForProject(project) : [];

      const row = document.createElement('div');
      row.className = 'grid md:grid-cols-12 gap-4 items-start bg-white rounded-xl border border-slate-100 p-4 shadow-sm';

      const tradeCol = document.createElement('div');
      tradeCol.className = 'md:col-span-5 space-y-2';
      tradeCol.innerHTML = `
        <label class="text-xs font-medium text-slate-600">Trade</label>
        <select data-index="${index}" class="trade-select w-full rounded-lg border border-slate-200 px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-slate-900/50" required ${project ? '' : 'disabled'}>
          <option value="" disabled selected>${project ? 'Select trade' : 'Select project first'}</option>
          ${trades.map((t) => `<option value="${t.trade}">${t.trade}</option>`).join('')}
        </select>`;

      const balanceCol = document.createElement('div');
      balanceCol.className = 'md:col-span-3 space-y-1';
      balanceCol.innerHTML = `
        <p class="text-xs font-medium text-slate-600">Remaining Balance</p>
        <p class="remaining-label text-lg font-semibold text-emerald-700">—</p>`;

      const amountCol = document.createElement('div');
      amountCol.className = 'md:col-span-4 space-y-2';
      amountCol.innerHTML = `
        <label class="text-xs font-medium text-slate-600">Amount</label>
        <div class="space-y-1">
          <input data-index="${index}" type="number" min="0" step="0.01" placeholder="0.00" class="amount-input w-full rounded-lg border border-slate-200 px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-slate-900/50" disabled />
          <p class="warning text-xs text-rose-600 hidden">Amount exceeds remaining balance.</p>
        </div>`;

      row.appendChild(tradeCol);
      row.appendChild(balanceCol);
      row.appendChild(amountCol);

      return row;
    }

    function updateRemainingLabels(selectEl) {
      const row = selectEl.closest('div.grid');
      const project = document.getElementById('projectSelect').value;
      const remainingLabel = row.querySelector('.remaining-label');
      const amountInput = row.querySelector('.amount-input');
      const trade = selectEl.value;

      const budget = state.budgets.find((b) => b.project === project && b.trade === trade);
      remainingLabel.textContent = budget ? formatCurrency(budget.remaining) : '—';

      if (budget) {
        amountInput.removeAttribute('disabled');
        amountInput.max = budget.remaining;
      } else {
        amountInput.setAttribute('disabled', 'true');
        amountInput.value = '';
      }

      validateAmount(row, budget?.remaining || 0);
      updateSummary();
    }

    function validateAmount(row, max) {
      const amountInput = row.querySelector('.amount-input');
      const warning = row.querySelector('.warning');
      const value = Number(amountInput.value);

      if (value > max) {
        amountInput.classList.add('border-rose-400', 'bg-rose-50');
        warning.classList.remove('hidden');
      } else {
        amountInput.classList.remove('border-rose-400', 'bg-rose-50');
        warning.classList.add('hidden');
      }

      updateTotals();
    }

    function updateTotals() {
      const row = document.querySelector('#lineItems .grid');
      const amount = Number(row?.querySelector('.amount-input')?.value) || 0;
      document.getElementById('totalAmount').textContent = formatCurrency(amount);
      updateSummary();
    }

    function getSelectedTradeAndAmount() {
      const row = document.querySelector('#lineItems .grid');
      const trade = row?.querySelector('.trade-select')?.value || '';
      const amount = Number(row?.querySelector('.amount-input')?.value) || 0;
      return { trade, amount };
    }

    function updateSummary() {
      const project = document.getElementById('projectSelect').value || '—';
      const contractorName = state.contractor?.name || '—';
      const { trade, amount } = getSelectedTradeAndAmount();
      const invoice = state.invoiceBase64 ? `Ready (${state.invoiceName || 'uploaded'})` : 'Pending';

      const summaryList = document.getElementById('summaryList');
      summaryList.innerHTML = `
        <li>Contractor: ${contractorName}</li>
        <li>Project: ${project}</li>
        <li>Trade: ${trade || '—'}</li>
        <li>Amount: ${formatCurrency(amount)}</li>
        <li>Invoice: ${invoice}</li>`;
    }

    function updatePaymentEstimate(selectedDate) {
      if (!selectedDate) {
        document.getElementById('estimatedPayment').textContent = 'Select a work date to calculate.';
        return;
      }
      const next = nextThursday(selectedDate);
      const formatted = next.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
      document.getElementById('estimatedPayment').textContent = `Estimated Payment Date: ${formatted}`;
    }

    function setupFlatpickr() {
      const today = new Date();
      const minDate = addDays(today, 3);

      document.getElementById('bufferMessage').textContent =
        `Earliest work date available is ${minDate.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' })}.`;

      flatpickr('#workDate', {
        minDate,
        dateFormat: 'm/d/Y',
        disableMobile: true,
        onChange: (selectedDates) => {
          updatePaymentEstimate(selectedDates[0]);
        },
      });
    }

    function setupFileUpload() {
      const dropzone = document.getElementById('dropzone');
      const fileInput = document.getElementById('fileInput');
      const fileInfo = document.getElementById('fileInfo');

      const handleFiles = (files) => {
        const file = files?.[0];
        if (!file) return;

        fileInfo.textContent = `${file.name} (${Math.round(file.size / 1024)} KB)`;

        const reader = new FileReader();
        reader.onload = () => {
          const dataUrl = reader.result;
          const base64 = typeof dataUrl === 'string' ? dataUrl.split(',')[1] : '';
          state.invoiceBase64 = base64;
          state.invoiceName = file.name;
          updateSummary();
        };
        reader.readAsDataURL(file);
      };

      dropzone.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

      dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('border-slate-400');
      });
      dropzone.addEventListener('dragleave', () => dropzone.classList.remove('border-slate-400'));
      dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('border-slate-400');
        handleFiles(e.dataTransfer.files);
      });
    }

    function statusBadgeClass(status) {
      if (status === 'Paid') return 'bg-emerald-50 text-emerald-700';
      if (status === 'Processing') return 'bg-blue-50 text-blue-700';
      if (status === 'Approved') return 'bg-indigo-50 text-indigo-700';
      return 'bg-amber-50 text-amber-700';
    }

    function renderStatusTable(rows) {
      const tbody = document.getElementById('statusTable');

      if (!rows || !rows.length) {
        tbody.innerHTML = `<tr><td class="py-4 text-slate-500" colspan="5">No draws submitted yet.</td></tr>`;
        return;
      }

      tbody.innerHTML = rows.map((row) => `
        <tr class="text-slate-800">
          <td class="py-3 pr-4">${row.project}</td>
          <td class="py-3 pr-4">${row.trade}</td>
          <td class="py-3 pr-4">${formatCurrency(row.amount)}</td>
          <td class="py-3 pr-4">
            <span class="inline-flex px-3 py-1 rounded-full text-xs font-semibold ${statusBadgeClass(row.status)}">${row.status}</span>
          </td>
          <td class="py-3 pr-4 text-slate-500">${row.updated || ''}</td>
        </tr>
      `).join('');
    }

    function setupSearchFilter() {
      document.getElementById('searchInput').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase().trim();
        if (!term) return renderStatusTable(state.statusRows);

        const filtered = state.statusRows.filter((row) =>
          [row.project, row.trade, row.status].some((v) => String(v).toLowerCase().includes(term))
        );
        renderStatusTable(filtered);
      });
    }

    function hidePinModal() {
      document.getElementById('pinModal').classList.add('hidden');
    }

    function setupPinModal() {
      const pinForm = document.getElementById('pinForm');
      const pinInput = document.getElementById('pinInput');
      const pinError = document.getElementById('pinError');
      const pinLoading = document.getElementById('pinLoading');
      const submitButton = document.getElementById('pinSubmit');

      pinInput.focus();

      pinForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const pin = pinInput.value.trim();
        if (!/^[0-9]{4}$/.test(pin)) {
          pinError.textContent = 'Please enter a 4-digit PIN.';
          pinError.classList.remove('hidden');
          return;
        }

        pinError.classList.add('hidden');
        pinLoading.classList.remove('hidden');
        submitButton.disabled = true;
        submitButton.textContent = 'Verifying...';

        try {
          const contractor = await verifyContractor(pin);

          if (!contractor?.name) {
            pinError.textContent = 'That PIN was not recognized. Please try again.';
            pinError.classList.remove('hidden');
            return;
          }

          state.pin = pin;
          state.contractor = { name: contractor.name };

          document.getElementById('headerContractorName').textContent = contractor.name;

          await loadBudgetsAndStatus();

          hidePinModal();

        } catch (err) {
          pinError.textContent = 'Could not reach the server. Please try again.';
          pinError.classList.remove('hidden');
        } finally {
          pinLoading.classList.add('hidden');
          submitButton.disabled = false;
          submitButton.textContent = 'Continue';
        }
      });
    }

    function setupLineItemEvents() {
      document.getElementById('projectSelect').addEventListener('change', () => {
        renderLineItems();
        updateSummary();
      });

      document.getElementById('lineItems').addEventListener('change', (e) => {
        if (e.target.classList.contains('trade-select')) {
          updateRemainingLabels(e.target);
        }
      });

      document.getElementById('lineItems').addEventListener('input', (e) => {
        if (e.target.classList.contains('amount-input')) {
          const row = e.target.closest('.grid');
          const tradeSelect = row.querySelector('.trade-select');
          const project = document.getElementById('projectSelect').value;
          const budget = state.budgets.find((b) => b.project === project && b.trade === tradeSelect.value);
          validateAmount(row, budget?.remaining || 0);
        }
      });
    }

    async function submitForm(event) {
      event.preventDefault();

      const msg = document.getElementById('submitMessage');
      msg.textContent = '';

      if (!state.pin || !state.contractor?.name) {
        msg.textContent = 'Please verify your PIN first.';
        return;
      }

      const project = document.getElementById('projectSelect').value;
      const workDate = document.getElementById('workDate').value;
      const estPayText = document.getElementById('estimatedPayment').textContent.replace('Estimated Payment Date: ', '').trim();

      const { trade, amount } = getSelectedTradeAndAmount();

      if (!project) return (msg.textContent = 'Please select a project.');
      if (!trade) return (msg.textContent = 'Please select a trade.');
      if (!amount || amount <= 0) return (msg.textContent = 'Please enter a valid amount.');
      if (!workDate) return (msg.textContent = 'Please select a work date.');

      const payload = {
        PIN: state.pin,
        ContractorName: state.contractor.name,
        Project: project,
        WorkDate: workDate,
        EstimatedPayment: estPayText,
        InvoiceFile: state.invoiceBase64,
        InvoiceFileName: state.invoiceName,
        LineItems: [{ trade, amount }],
      };

      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';

      try {
        // ✅ Works from GitHub Pages. We cannot read the response.
        await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(payload),
        });

        showOkModal('Submitted', 'Your draw request was submitted. Tap OK to continue.');

        // Refresh status list (best effort)
        try {
          const stat = await apiGet(`${SCRIPT_URL}?action=status&pin=${encodeURIComponent(state.pin)}`);
          state.statusRows = (stat?.ok && Array.isArray(stat.rows)) ? stat.rows : state.statusRows;
          renderStatusTable(state.statusRows);
        } catch (_) {}

      } catch (error) {
        showOkModal('Error', 'There was an issue submitting your request. Please try again.');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Draw Request';
      }
    }

    function init() {
      setupFlatpickr();
      setupFileUpload();
      setupLineItemEvents();
      setupPinModal();
      setupSearchFilter();
      updateSummary();
      document.getElementById('drawForm').addEventListener('submit', submitForm);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
